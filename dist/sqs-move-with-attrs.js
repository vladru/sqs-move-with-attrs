"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class SqsMoveWithAttrs {
    constructor(sqsClient, fromSqsUrl, toSqsUrl) {
        this.castMessageAttributes = (source) => {
            for (const key in source) {
                // noinspection JSUnfilteredForInLoop
                delete source[key].StringListValues;
                // noinspection JSUnfilteredForInLoop
                delete source[key].BinaryListValues;
            }
            return source;
        };
        this.sqsClient = sqsClient;
        this.fromSqsUrl = fromSqsUrl;
        this.toSqsUrl = toSqsUrl;
        this.receiveOptions = {
            MessageAttributeNames: [
                "All"
            ],
            QueueUrl: fromSqsUrl,
            MaxNumberOfMessages: 10,
            VisibilityTimeout: 30,
            WaitTimeSeconds: 0
        };
        this.processedMessagesCount = 0;
        this.jobLaunchingCount = 0;
    }
    reportProgress(numMessages) {
        this.processedMessagesCount += numMessages;
        process.stdout.write("\rMessages moved:" + this.processedMessagesCount);
    }
    async moveJob(jobNum) {
        // for Debugging
        // if (++this.jobLaunchingCount > 100) {
        //     return
        // }
        let response = await this.sqsClient.receiveMessage(this.receiveOptions).promise();
        if (!response.Messages) {
            return;
        }
        let sendRequest = {
            QueueUrl: this.toSqsUrl,
            Entries: []
        };
        let deleteRequest = {
            QueueUrl: this.fromSqsUrl,
            Entries: []
        };
        let id = 0;
        for (const message of response.Messages) {
            if (message.Body && message.ReceiptHandle) {
                id++;
                const sendEntry = {
                    Id: '' + id,
                    MessageBody: message.Body
                };
                if (message.MessageAttributes) {
                    sendEntry.MessageAttributes = this.castMessageAttributes(message.MessageAttributes);
                }
                sendRequest.Entries.push(sendEntry);
                deleteRequest.Entries.push({
                    Id: '' + id,
                    ReceiptHandle: message.ReceiptHandle
                });
            }
        }
        await this.sqsClient.sendMessageBatch(sendRequest).promise();
        await this.sqsClient.deleteMessageBatch(deleteRequest).promise();
        this.reportProgress(response.Messages.length);
        // release memory before recursive call
        sendRequest = null;
        deleteRequest = null;
        response = null;
        return this.moveJob(jobNum);
    }
    async move(jobConcurrency = 50) {
        const moveJobs = [];
        for (let i = 0; i < jobConcurrency; i++) {
            moveJobs.push(this.moveJob(i + 1));
        }
        return Promise.all(moveJobs);
    }
}
exports.SqsMoveWithAttrs = SqsMoveWithAttrs;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3FzLW1vdmUtd2l0aC1hdHRycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zcXMtbW92ZS13aXRoLWF0dHJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsTUFBYSxnQkFBZ0I7SUFVekIsWUFBWSxTQUFjLEVBQUUsVUFBa0IsRUFBRSxRQUFnQjtRQXdCeEQsMEJBQXFCLEdBQUcsQ0FBQyxNQUFtQyxFQUErQixFQUFFO1lBQ2pHLEtBQU0sTUFBTSxHQUFHLElBQUksTUFBTSxFQUFFO2dCQUN2QixxQ0FBcUM7Z0JBQ3JDLE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLGdCQUFnQixDQUFDO2dCQUNwQyxxQ0FBcUM7Z0JBQ3JDLE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLGdCQUFnQixDQUFDO2FBQ3ZDO1lBQ0QsT0FBTyxNQUFNLENBQUM7UUFDbEIsQ0FBQyxDQUFDO1FBL0JFLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBRXpCLElBQUksQ0FBQyxjQUFjLEdBQUc7WUFDbEIscUJBQXFCLEVBQUU7Z0JBQ25CLEtBQUs7YUFDUjtZQUNELFFBQVEsRUFBRSxVQUFVO1lBQ3BCLG1CQUFtQixFQUFFLEVBQUU7WUFDdkIsaUJBQWlCLEVBQUUsRUFBRTtZQUNyQixlQUFlLEVBQUUsQ0FBQztTQUNyQixDQUFDO1FBRUYsSUFBSSxDQUFDLHNCQUFzQixHQUFHLENBQUMsQ0FBQztRQUNoQyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsQ0FBQyxDQUFDO0lBQy9CLENBQUM7SUFFTyxjQUFjLENBQUMsV0FBbUI7UUFDdEMsSUFBSSxDQUFDLHNCQUFzQixJQUFJLFdBQVcsQ0FBQztRQUMzQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsR0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUMxRSxDQUFDO0lBWU8sS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFjO1FBQ2hDLGdCQUFnQjtRQUNoQix3Q0FBd0M7UUFDeEMsYUFBYTtRQUNiLElBQUk7UUFFSixJQUFJLFFBQVEsR0FBb0MsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDbkgsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUU7WUFDcEIsT0FBTTtTQUNUO1FBRUQsSUFBSSxXQUFXLEdBQXVDO1lBQ2xELFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtZQUN2QixPQUFPLEVBQUUsRUFBRTtTQUNkLENBQUM7UUFDRixJQUFJLGFBQWEsR0FBeUM7WUFDdEQsUUFBUSxFQUFFLElBQUksQ0FBQyxVQUFVO1lBQ3pCLE9BQU8sRUFBRSxFQUFFO1NBQ2QsQ0FBQztRQUVGLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNYLEtBQUssTUFBTSxPQUFPLElBQUksUUFBUSxDQUFDLFFBQVEsRUFBRTtZQUNyQyxJQUFJLE9BQU8sQ0FBQyxJQUFJLElBQUksT0FBTyxDQUFDLGFBQWEsRUFBRTtnQkFDdkMsRUFBRSxFQUFFLENBQUM7Z0JBQ0wsTUFBTSxTQUFTLEdBQXFDO29CQUNoRCxFQUFFLEVBQUUsRUFBRSxHQUFDLEVBQUU7b0JBQ1QsV0FBVyxFQUFFLE9BQU8sQ0FBQyxJQUFJO2lCQUM1QixDQUFDO2dCQUNGLElBQUksT0FBTyxDQUFDLGlCQUFpQixFQUFFO29CQUMzQixTQUFTLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO2lCQUN0RjtnQkFDRCxXQUFXLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDcEMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7b0JBQ3ZCLEVBQUUsRUFBRSxFQUFFLEdBQUMsRUFBRTtvQkFDVCxhQUFhLEVBQUUsT0FBTyxDQUFDLGFBQWE7aUJBQ3ZDLENBQUMsQ0FBQTthQUNMO1NBQ0o7UUFFRCxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDN0QsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDLGFBQWEsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRWpFLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUU5Qyx1Q0FBdUM7UUFDdkMsV0FBVyxHQUFHLElBQUksQ0FBQztRQUNuQixhQUFhLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFFaEIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFTSxLQUFLLENBQUMsSUFBSSxDQUFDLGNBQWMsR0FBRSxFQUFFO1FBQ2hDLE1BQU0sUUFBUSxHQUFvQixFQUFFLENBQUM7UUFDckMsS0FBSyxJQUFJLENBQUMsR0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLGNBQWMsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNuQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDcEM7UUFDRCxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUE7SUFDaEMsQ0FBQztDQUNKO0FBdkdELDRDQXVHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7U1FTfSBmcm9tIFwiYXdzLXNka1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIFNxc01vdmVXaXRoQXR0cnMge1xyXG5cclxuICAgIHByaXZhdGUgcmVhZG9ubHkgc3FzQ2xpZW50OiBTUVM7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZyb21TcXNVcmw6IHN0cmluZztcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgdG9TcXNVcmw6IHN0cmluZztcclxuXHJcbiAgICBwcml2YXRlIHByb2Nlc3NlZE1lc3NhZ2VzQ291bnQ6IG51bWJlcjtcclxuICAgIHByaXZhdGUgam9iTGF1bmNoaW5nQ291bnQ6IG51bWJlcjtcclxuICAgIHByaXZhdGUgcmVjZWl2ZU9wdGlvbnM6IFNRUy5SZWNlaXZlTWVzc2FnZVJlcXVlc3Q7XHJcblxyXG4gICAgY29uc3RydWN0b3Ioc3FzQ2xpZW50OiBTUVMsIGZyb21TcXNVcmw6IHN0cmluZywgdG9TcXNVcmw6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuc3FzQ2xpZW50ID0gc3FzQ2xpZW50O1xyXG4gICAgICAgIHRoaXMuZnJvbVNxc1VybCA9IGZyb21TcXNVcmw7XHJcbiAgICAgICAgdGhpcy50b1Nxc1VybCA9IHRvU3FzVXJsO1xyXG5cclxuICAgICAgICB0aGlzLnJlY2VpdmVPcHRpb25zID0ge1xyXG4gICAgICAgICAgICBNZXNzYWdlQXR0cmlidXRlTmFtZXM6IFtcclxuICAgICAgICAgICAgICAgIFwiQWxsXCJcclxuICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgUXVldWVVcmw6IGZyb21TcXNVcmwsXHJcbiAgICAgICAgICAgIE1heE51bWJlck9mTWVzc2FnZXM6IDEwLFxyXG4gICAgICAgICAgICBWaXNpYmlsaXR5VGltZW91dDogMzAsXHJcbiAgICAgICAgICAgIFdhaXRUaW1lU2Vjb25kczogMFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRoaXMucHJvY2Vzc2VkTWVzc2FnZXNDb3VudCA9IDA7XHJcbiAgICAgICAgdGhpcy5qb2JMYXVuY2hpbmdDb3VudCA9IDA7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZXBvcnRQcm9ncmVzcyhudW1NZXNzYWdlczogbnVtYmVyKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5wcm9jZXNzZWRNZXNzYWdlc0NvdW50ICs9IG51bU1lc3NhZ2VzO1xyXG4gICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKFwiXFxyTWVzc2FnZXMgbW92ZWQ6XCIrdGhpcy5wcm9jZXNzZWRNZXNzYWdlc0NvdW50KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNhc3RNZXNzYWdlQXR0cmlidXRlcyA9IChzb3VyY2U6IFNRUy5NZXNzYWdlQm9keUF0dHJpYnV0ZU1hcCk6IFNRUy5NZXNzYWdlQm9keUF0dHJpYnV0ZU1hcCA9PiB7XHJcbiAgICAgICAgZm9yICggY29uc3Qga2V5IGluIHNvdXJjZSkge1xyXG4gICAgICAgICAgICAvLyBub2luc3BlY3Rpb24gSlNVbmZpbHRlcmVkRm9ySW5Mb29wXHJcbiAgICAgICAgICAgIGRlbGV0ZSBzb3VyY2Vba2V5XS5TdHJpbmdMaXN0VmFsdWVzO1xyXG4gICAgICAgICAgICAvLyBub2luc3BlY3Rpb24gSlNVbmZpbHRlcmVkRm9ySW5Mb29wXHJcbiAgICAgICAgICAgIGRlbGV0ZSBzb3VyY2Vba2V5XS5CaW5hcnlMaXN0VmFsdWVzO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc291cmNlO1xyXG4gICAgfTtcclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIG1vdmVKb2Ioam9iTnVtOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICAvLyBmb3IgRGVidWdnaW5nXHJcbiAgICAgICAgLy8gaWYgKCsrdGhpcy5qb2JMYXVuY2hpbmdDb3VudCA+IDEwMCkge1xyXG4gICAgICAgIC8vICAgICByZXR1cm5cclxuICAgICAgICAvLyB9XHJcblxyXG4gICAgICAgIGxldCByZXNwb25zZTogU1FTLlJlY2VpdmVNZXNzYWdlUmVzdWx0IHwgbnVsbCA9IGF3YWl0IHRoaXMuc3FzQ2xpZW50LnJlY2VpdmVNZXNzYWdlKHRoaXMucmVjZWl2ZU9wdGlvbnMpLnByb21pc2UoKTtcclxuICAgICAgICBpZiAoIXJlc3BvbnNlLk1lc3NhZ2VzKSB7XHJcbiAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHNlbmRSZXF1ZXN0OiBTUVMuU2VuZE1lc3NhZ2VCYXRjaFJlcXVlc3QgfCBudWxsID0ge1xyXG4gICAgICAgICAgICBRdWV1ZVVybDogdGhpcy50b1Nxc1VybCxcclxuICAgICAgICAgICAgRW50cmllczogW11cclxuICAgICAgICB9O1xyXG4gICAgICAgIGxldCBkZWxldGVSZXF1ZXN0OiBTUVMuRGVsZXRlTWVzc2FnZUJhdGNoUmVxdWVzdCB8IG51bGwgPSB7XHJcbiAgICAgICAgICAgIFF1ZXVlVXJsOiB0aGlzLmZyb21TcXNVcmwsXHJcbiAgICAgICAgICAgIEVudHJpZXM6IFtdXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgbGV0IGlkID0gMDtcclxuICAgICAgICBmb3IgKGNvbnN0IG1lc3NhZ2Ugb2YgcmVzcG9uc2UuTWVzc2FnZXMpIHtcclxuICAgICAgICAgICAgaWYgKG1lc3NhZ2UuQm9keSAmJiBtZXNzYWdlLlJlY2VpcHRIYW5kbGUpIHtcclxuICAgICAgICAgICAgICAgIGlkKys7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzZW5kRW50cnk6IFNRUy5TZW5kTWVzc2FnZUJhdGNoUmVxdWVzdEVudHJ5ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIElkOiAnJytpZCxcclxuICAgICAgICAgICAgICAgICAgICBNZXNzYWdlQm9keTogbWVzc2FnZS5Cb2R5XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UuTWVzc2FnZUF0dHJpYnV0ZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZW5kRW50cnkuTWVzc2FnZUF0dHJpYnV0ZXMgPSB0aGlzLmNhc3RNZXNzYWdlQXR0cmlidXRlcyhtZXNzYWdlLk1lc3NhZ2VBdHRyaWJ1dGVzKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgc2VuZFJlcXVlc3QuRW50cmllcy5wdXNoKHNlbmRFbnRyeSk7XHJcbiAgICAgICAgICAgICAgICBkZWxldGVSZXF1ZXN0LkVudHJpZXMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgSWQ6ICcnK2lkLFxyXG4gICAgICAgICAgICAgICAgICAgIFJlY2VpcHRIYW5kbGU6IG1lc3NhZ2UuUmVjZWlwdEhhbmRsZVxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgYXdhaXQgdGhpcy5zcXNDbGllbnQuc2VuZE1lc3NhZ2VCYXRjaChzZW5kUmVxdWVzdCkucHJvbWlzZSgpO1xyXG4gICAgICAgIGF3YWl0IHRoaXMuc3FzQ2xpZW50LmRlbGV0ZU1lc3NhZ2VCYXRjaChkZWxldGVSZXF1ZXN0KS5wcm9taXNlKCk7XHJcblxyXG4gICAgICAgIHRoaXMucmVwb3J0UHJvZ3Jlc3MocmVzcG9uc2UuTWVzc2FnZXMubGVuZ3RoKTtcclxuXHJcbiAgICAgICAgLy8gcmVsZWFzZSBtZW1vcnkgYmVmb3JlIHJlY3Vyc2l2ZSBjYWxsXHJcbiAgICAgICAgc2VuZFJlcXVlc3QgPSBudWxsO1xyXG4gICAgICAgIGRlbGV0ZVJlcXVlc3QgPSBudWxsO1xyXG4gICAgICAgIHJlc3BvbnNlID0gbnVsbDtcclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMubW92ZUpvYihqb2JOdW0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyBtb3ZlKGpvYkNvbmN1cnJlbmN5PSA1MCk6IFByb21pc2U8dm9pZFtdPiB7XHJcbiAgICAgICAgY29uc3QgbW92ZUpvYnM6IFByb21pc2U8dm9pZD5bXSA9IFtdO1xyXG4gICAgICAgIGZvciAobGV0IGk9MDsgaSA8IGpvYkNvbmN1cnJlbmN5OyBpKyspIHtcclxuICAgICAgICAgICAgbW92ZUpvYnMucHVzaCh0aGlzLm1vdmVKb2IoaSsxKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChtb3ZlSm9icylcclxuICAgIH1cclxufVxyXG4iXX0=