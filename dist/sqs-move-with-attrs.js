'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
// https://docs.aws.amazon.com/AWSSimpleQueueService/latest/APIReference/API_SendMessageBatch.html
const MAX_SEND_MESSAGE_PAYLOAD_SIZE_BYTES = 256 * 1024;
class SqsMoveWithAttrs {
    constructor(sqsClient, fromSqsUrl, toSqsUrl) {
        this.castMessageAttributes = (source) => {
            for (const key in source) {
                // noinspection JSUnfilteredForInLoop
                delete source[key].StringListValues;
                // noinspection JSUnfilteredForInLoop
                delete source[key].BinaryListValues;
            }
            return source;
        };
        this.createSendMessageBatchRequest = () => {
            return {
                QueueUrl: this.toSqsUrl,
                Entries: []
            };
        };
        this.getSendEntrySizeInBytes = (entry) => {
            const str = JSON.stringify(entry);
            return Buffer.byteLength(str, "utf-8");
        };
        this.sqsClient = sqsClient;
        this.fromSqsUrl = fromSqsUrl;
        this.toSqsUrl = toSqsUrl;
        this.receiveOptions = {
            MessageAttributeNames: [
                "All"
            ],
            QueueUrl: fromSqsUrl,
            MaxNumberOfMessages: 10,
            VisibilityTimeout: 30,
            WaitTimeSeconds: 0
        };
        this.receivedMessagesCount = 0;
        this.movedMessagesCount = 0;
    }
    reportProgress(receivedMessages, movedMessages) {
        this.receivedMessagesCount += receivedMessages;
        this.movedMessagesCount += movedMessages;
        process.stdout.write("\rMessages received " + this.receivedMessagesCount + ", moved " + this.movedMessagesCount);
    }
    /**
     * @return promise resolved with number of moved messages
     */
    async moveJob() {
        const deleteRequest = {
            QueueUrl: this.fromSqsUrl,
            Entries: []
        };
        let movedMessagesCount = 0;
        do {
            const receiveBatchResponse = await this.sqsClient.receiveMessage(this.receiveOptions).promise();
            if (!receiveBatchResponse.Messages) {
                return movedMessagesCount;
            }
            let id = 0;
            const sendRequests = [];
            let sendRequest = this.createSendMessageBatchRequest();
            let sendRequestPayloadSize = 0;
            deleteRequest.Entries = [];
            for (const message of receiveBatchResponse.Messages) {
                if (message.Body && message.ReceiptHandle) {
                    id++;
                    const sendEntry = {
                        Id: '' + id,
                        MessageBody: message.Body
                    };
                    if (message.MessageAttributes) {
                        sendEntry.MessageAttributes = this.castMessageAttributes(message.MessageAttributes);
                    }
                    const sendEntrySize = this.getSendEntrySizeInBytes(sendEntry);
                    if (sendRequestPayloadSize + sendEntrySize > MAX_SEND_MESSAGE_PAYLOAD_SIZE_BYTES) {
                        sendRequests.push(sendRequest);
                        sendRequest = this.createSendMessageBatchRequest();
                        sendRequestPayloadSize = 0;
                    }
                    sendRequestPayloadSize += sendEntrySize;
                    sendRequest.Entries.push(sendEntry);
                    deleteRequest.Entries.push({
                        Id: '' + id,
                        ReceiptHandle: message.ReceiptHandle
                    });
                }
            }
            sendRequests.push(sendRequest);
            const failedIds = [];
            for (const request of sendRequests) {
                const sendBatchResponse = await this.sqsClient.sendMessageBatch(request).promise();
                sendBatchResponse.Failed.forEach((entry) => {
                    console.error(" Send message failure: %s, error code %s", entry.Message, entry.Code);
                    failedIds.push(entry.Id);
                });
            }
            // delete failed IDs from deleteRequest.Entries
            failedIds.forEach(failedId => {
                const deleteEntryIndex = deleteRequest.Entries.findIndex(it => it.Id === failedId);
                if (deleteEntryIndex > -1) {
                    deleteRequest.Entries.splice(deleteEntryIndex, 1);
                }
            });
            await this.sqsClient.deleteMessageBatch(deleteRequest).promise();
            movedMessagesCount += deleteRequest.Entries.length;
            this.reportProgress(receiveBatchResponse.Messages.length, movedMessagesCount);
            // eslint-disable-next-line no-constant-condition
        } while (true);
    }
    /**
     * Do moving messages from source to destination queue
     * @param jobConcurrency
     * @return promise resolved with number of moved messages
     */
    async move(jobConcurrency = 50) {
        const moveJobs = [];
        for (let i = 0; i < jobConcurrency; i++) {
            moveJobs.push(this.moveJob());
        }
        const result = await Promise.all(moveJobs);
        return result.reduce((prevValue, currentValue) => { return prevValue + currentValue; }, 0);
    }
}
exports.SqsMoveWithAttrs = SqsMoveWithAttrs;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3FzLW1vdmUtd2l0aC1hdHRycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zcXMtbW92ZS13aXRoLWF0dHJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7QUFJYixrR0FBa0c7QUFDbEcsTUFBTSxtQ0FBbUMsR0FBRSxHQUFHLEdBQUMsSUFBSSxDQUFDO0FBRXBELE1BQWEsZ0JBQWdCO0lBVXpCLFlBQVksU0FBYyxFQUFFLFVBQWtCLEVBQUUsUUFBZ0I7UUF5QnhELDBCQUFxQixHQUFHLENBQUMsTUFBbUMsRUFBK0IsRUFBRTtZQUNqRyxLQUFNLE1BQU0sR0FBRyxJQUFJLE1BQU0sRUFBRTtnQkFDdkIscUNBQXFDO2dCQUNyQyxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDcEMscUNBQXFDO2dCQUNyQyxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQzthQUN2QztZQUNELE9BQU8sTUFBTSxDQUFDO1FBQ2xCLENBQUMsQ0FBQztRQUVNLGtDQUE2QixHQUFHLEdBQWdDLEVBQUU7WUFDeEUsT0FBTztnQkFDSCxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7Z0JBQ3ZCLE9BQU8sRUFBRSxFQUFFO2FBQ2QsQ0FBQTtRQUNILENBQUMsQ0FBQztRQUVNLDRCQUF1QixHQUFHLENBQUMsS0FBdUMsRUFBVSxFQUFFO1lBQ2xGLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbEMsT0FBTyxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQTtRQUMxQyxDQUFDLENBQUM7UUE1Q0UsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDN0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFFekIsSUFB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QUlHO0lBQ0ksS0FBSyxDQUFDLElBQUksQ0FBQyxjQUFjLEdBQUUsRUFBRTtRQUNoQyxNQUFNLFFBQVEsR0FBc0IsRUFBRSxDQUFDO1FBQ3ZDLEtBQUssSUFBSSxDQUFDLEdBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxjQUFjLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDbkMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztTQUNqQztRQUNELE1BQU0sTUFBTSxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMzQyxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUUsQ0FBQyxTQUFTLEVBQUUsWUFBWSxFQUFFLEVBQUUsR0FBRyxPQUFPLFNBQVMsR0FBRyxZQUFZLENBQUEsQ0FBQSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDN0YsQ0FBQztDQUNKO0FBbEpELDRDQWtKQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxuXHJcbmltcG9ydCB7U1FTfSBmcm9tIFwiYXdzLXNka1wiO1xyXG5cclxuLy8gaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL0FXU1NpbXBsZVF1ZXVlU2VydmljZS9sYXRlc3QvQVBJUmVmZXJlbmNlL0FQSV9TZW5kTWVzc2FnZUJhdGNoLmh0bWxcclxuY29uc3QgTUFYX1NFTkRfTUVTU0FHRV9QQVlMT0FEX1NJWkVfQllURVMgPTI1NioxMDI0O1xyXG5cclxuZXhwb3J0IGNsYXNzIFNxc01vdmVXaXRoQXR0cnMge1xyXG5cclxuICAgIHByaXZhdGUgcmVhZG9ubHkgc3FzQ2xpZW50OiBTUVM7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZyb21TcXNVcmw6IHN0cmluZztcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgdG9TcXNVcmw6IHN0cmluZztcclxuXHJcbiAgICBwcml2YXRlIHJlY2VpdmVkTWVzc2FnZXNDb3VudDogbnVtYmVyO1xyXG4gICAgcHJpdmF0ZSBtb3ZlZE1lc3NhZ2VzQ291bnQ6IG51bWJlcjtcclxuICAgIHByaXZhdGUgcmVjZWl2ZU9wdGlvbnM6IFNRUy5SZWNlaXZlTWVzc2FnZVJlcXVlc3Q7XHJcblxyXG4gICAgY29uc3RydWN0b3Ioc3FzQ2xpZW50OiBTUVMsIGZyb21TcXNVcmw6IHN0cmluZywgdG9TcXNVcmw6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuc3FzQ2xpZW50ID0gc3FzQ2xpZW50O1xyXG4gICAgICAgIHRoaXMuZnJvbVNxc1VybCA9IGZyb21TcXNVcmw7XHJcbiAgICAgICAgdGhpcy50b1Nxc1VybCA9IHRvU3FzVXJsO1xyXG5cclxuICAgICAgICB0aGlzLnJlY2VpdmVPcHRpb25zID0ge1xyXG4gICAgICAgICAgICBNZXNzYWdlQXR0cmlidXRlTmFtZXM6IFtcclxuICAgICAgICAgICAgICAgIFwiQWxsXCJcclxuICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgUXVldWVVcmw6IGZyb21TcXNVcmwsXHJcbiAgICAgICAgICAgIE1heE51bWJlck9mTWVzc2FnZXM6IDEwLFxyXG4gICAgICAgICAgICBWaXNpYmlsaXR5VGltZW91dDogMzAsXHJcbiAgICAgICAgICAgIFdhaXRUaW1lU2Vjb25kczogMFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRoaXMucmVjZWl2ZWRNZXNzYWdlc0NvdW50ID0gMDtcclxuICAgICAgICB0aGlzLm1vdmVkTWVzc2FnZXNDb3VudCA9IDA7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZXBvcnRQcm9ncmVzcyhyZWNlaXZlZE1lc3NhZ2VzOiBudW1iZXIsIG1vdmVkTWVzc2FnZXM6IG51bWJlcik6IHZvaWQge1xyXG4gICAgICAgIHRoaXMucmVjZWl2ZWRNZXNzYWdlc0NvdW50ICs9IHJlY2VpdmVkTWVzc2FnZXM7XHJcbiAgICAgICAgdGhpcy5tb3ZlZE1lc3NhZ2VzQ291bnQgKz0gbW92ZWRNZXNzYWdlcztcclxuICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShcIlxcck1lc3NhZ2VzIHJlY2VpdmVkIFwiK3RoaXMucmVjZWl2ZWRNZXNzYWdlc0NvdW50K1wiLCBtb3ZlZCBcIit0aGlzLm1vdmVkTWVzc2FnZXNDb3VudCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjYXN0TWVzc2FnZUF0dHJpYnV0ZXMgPSAoc291cmNlOiBTUVMuTWVzc2FnZUJvZHlBdHRyaWJ1dGVNYXApOiBTUVMuTWVzc2FnZUJvZHlBdHRyaWJ1dGVNYXAgPT4ge1xyXG4gICAgICAgIGZvciAoIGNvbnN0IGtleSBpbiBzb3VyY2UpIHtcclxuICAgICAgICAgICAgLy8gbm9pbnNwZWN0aW9uIEpTVW5maWx0ZXJlZEZvckluTG9vcFxyXG4gICAgICAgICAgICBkZWxldGUgc291cmNlW2tleV0uU3RyaW5nTGlzdFZhbHVlcztcclxuICAgICAgICAgICAgLy8gbm9pbnNwZWN0aW9uIEpTVW5maWx0ZXJlZEZvckluTG9vcFxyXG4gICAgICAgICAgICBkZWxldGUgc291cmNlW2tleV0uQmluYXJ5TGlzdFZhbHVlcztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHNvdXJjZTtcclxuICAgIH07XHJcblxyXG4gICAgcHJpdmF0ZSBjcmVhdGVTZW5kTWVzc2FnZUJhdGNoUmVxdWVzdCA9ICgpOiBTUVMuU2VuZE1lc3NhZ2VCYXRjaFJlcXVlc3QgPT4ge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgUXVldWVVcmw6IHRoaXMudG9TcXNVcmwsXHJcbiAgICAgICAgICBFbnRyaWVzOiBbXVxyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIHByaXZhdGUgZ2V0U2VuZEVudHJ5U2l6ZUluQnl0ZXMgPSAoZW50cnk6IFNRUy5TZW5kTWVzc2FnZUJhdGNoUmVxdWVzdEVudHJ5KTogbnVtYmVyID0+IHtcclxuICAgICAgICBjb25zdCBzdHIgPSBKU09OLnN0cmluZ2lmeShlbnRyeSk7XHJcbiAgICAgICAgcmV0dXJuIEJ1ZmZlci5ieXRlTGVuZ3RoKHN0ciwgXCJ1dGYtOFwiKVxyXG4gICAgfTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEByZXR1cm4gcHJvbWlzZSByZXNvbHZlZCB3aXRoIG51bWJlciBvZiBtb3ZlZCBtZXNzYWdlc1xyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGFzeW5jIG1vdmVKb2IoKTogUHJvbWlzZTxudW1iZXI+IHtcclxuXHJcbiAgICAgICAgY29uc3QgZGVsZXRlUmVxdWVzdDogU1FTLkRlbGV0ZU1lc3NhZ2VCYXRjaFJlcXVlc3QgPSB7XHJcbiAgICAgICAgICAgIFF1ZXVlVXJsOiB0aGlzLmZyb21TcXNVcmwsXHJcbiAgICAgICAgICAgIEVudHJpZXM6IFtdXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgbGV0IG1vdmVkTWVzc2FnZXNDb3VudCA9IDA7XHJcblxyXG4gICAgICAgIGRvIHtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHJlY2VpdmVCYXRjaFJlc3BvbnNlOiBTUVMuUmVjZWl2ZU1lc3NhZ2VSZXN1bHQgPSBhd2FpdCB0aGlzLnNxc0NsaWVudC5yZWNlaXZlTWVzc2FnZSh0aGlzLnJlY2VpdmVPcHRpb25zKS5wcm9taXNlKCk7XHJcbiAgICAgICAgICAgIGlmICghcmVjZWl2ZUJhdGNoUmVzcG9uc2UuTWVzc2FnZXMpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBtb3ZlZE1lc3NhZ2VzQ291bnRcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IGlkID0gMDtcclxuICAgICAgICAgICAgY29uc3Qgc2VuZFJlcXVlc3RzOiBTUVMuU2VuZE1lc3NhZ2VCYXRjaFJlcXVlc3RbXSA9IFtdO1xyXG4gICAgICAgICAgICBsZXQgc2VuZFJlcXVlc3QgPSB0aGlzLmNyZWF0ZVNlbmRNZXNzYWdlQmF0Y2hSZXF1ZXN0KCk7XHJcbiAgICAgICAgICAgIGxldCBzZW5kUmVxdWVzdFBheWxvYWRTaXplID0gMDtcclxuICAgICAgICAgICAgZGVsZXRlUmVxdWVzdC5FbnRyaWVzID0gW107XHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgbWVzc2FnZSBvZiByZWNlaXZlQmF0Y2hSZXNwb25zZS5NZXNzYWdlcykge1xyXG4gICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UuQm9keSAmJiBtZXNzYWdlLlJlY2VpcHRIYW5kbGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZCsrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlbmRFbnRyeTogU1FTLlNlbmRNZXNzYWdlQmF0Y2hSZXF1ZXN0RW50cnkgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIElkOiAnJytpZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgTWVzc2FnZUJvZHk6IG1lc3NhZ2UuQm9keVxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UuTWVzc2FnZUF0dHJpYnV0ZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VuZEVudHJ5Lk1lc3NhZ2VBdHRyaWJ1dGVzID0gdGhpcy5jYXN0TWVzc2FnZUF0dHJpYnV0ZXMobWVzc2FnZS5NZXNzYWdlQXR0cmlidXRlcylcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VuZEVudHJ5U2l6ZSA9IHRoaXMuZ2V0U2VuZEVudHJ5U2l6ZUluQnl0ZXMoc2VuZEVudHJ5KTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc2VuZFJlcXVlc3RQYXlsb2FkU2l6ZSArIHNlbmRFbnRyeVNpemUgPiBNQVhfU0VORF9NRVNTQUdFX1BBWUxPQURfU0laRV9CWVRFUykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZW5kUmVxdWVzdHMucHVzaChzZW5kUmVxdWVzdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRSZXF1ZXN0ID0gdGhpcy5jcmVhdGVTZW5kTWVzc2FnZUJhdGNoUmVxdWVzdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZW5kUmVxdWVzdFBheWxvYWRTaXplID0gMDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgc2VuZFJlcXVlc3RQYXlsb2FkU2l6ZSArPSBzZW5kRW50cnlTaXplO1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbmRSZXF1ZXN0LkVudHJpZXMucHVzaChzZW5kRW50cnkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlcXVlc3QuRW50cmllcy5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgSWQ6ICcnK2lkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBSZWNlaXB0SGFuZGxlOiBtZXNzYWdlLlJlY2VpcHRIYW5kbGVcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBzZW5kUmVxdWVzdHMucHVzaChzZW5kUmVxdWVzdCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGZhaWxlZElkczogc3RyaW5nW10gPSBbXTtcclxuICAgICAgICAgICAgZm9yIChjb25zdCByZXF1ZXN0IG9mIHNlbmRSZXF1ZXN0cykge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VuZEJhdGNoUmVzcG9uc2UgPSBhd2FpdCB0aGlzLnNxc0NsaWVudC5zZW5kTWVzc2FnZUJhdGNoKHJlcXVlc3QpLnByb21pc2UoKTtcclxuICAgICAgICAgICAgICAgIHNlbmRCYXRjaFJlc3BvbnNlLkZhaWxlZC5mb3JFYWNoKCAoZW50cnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiIFNlbmQgbWVzc2FnZSBmYWlsdXJlOiAlcywgZXJyb3IgY29kZSAlc1wiLCBlbnRyeS5NZXNzYWdlLCBlbnRyeS5Db2RlKTtcclxuICAgICAgICAgICAgICAgICAgICBmYWlsZWRJZHMucHVzaChlbnRyeS5JZClcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gZGVsZXRlIGZhaWxlZCBJRHMgZnJvbSBkZWxldGVSZXF1ZXN0LkVudHJpZXNcclxuICAgICAgICAgICAgZmFpbGVkSWRzLmZvckVhY2goIGZhaWxlZElkID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRlbGV0ZUVudHJ5SW5kZXggPSBkZWxldGVSZXF1ZXN0LkVudHJpZXMuZmluZEluZGV4KCBpdCA9PiBpdC5JZCA9PT0gZmFpbGVkSWQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGRlbGV0ZUVudHJ5SW5kZXggPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlcXVlc3QuRW50cmllcy5zcGxpY2UoZGVsZXRlRW50cnlJbmRleCwxKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc3FzQ2xpZW50LmRlbGV0ZU1lc3NhZ2VCYXRjaChkZWxldGVSZXF1ZXN0KS5wcm9taXNlKCk7XHJcblxyXG4gICAgICAgICAgICBtb3ZlZE1lc3NhZ2VzQ291bnQgKz0gZGVsZXRlUmVxdWVzdC5FbnRyaWVzLmxlbmd0aDtcclxuICAgICAgICAgICAgdGhpcy5yZXBvcnRQcm9ncmVzcyhyZWNlaXZlQmF0Y2hSZXNwb25zZS5NZXNzYWdlcy5sZW5ndGgsIG1vdmVkTWVzc2FnZXNDb3VudCk7XHJcblxyXG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc3RhbnQtY29uZGl0aW9uXHJcbiAgICAgICAgfSB3aGlsZSAodHJ1ZSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogRG8gbW92aW5nIG1lc3NhZ2VzIGZyb20gc291cmNlIHRvIGRlc3RpbmF0aW9uIHF1ZXVlXHJcbiAgICAgKiBAcGFyYW0gam9iQ29uY3VycmVuY3lcclxuICAgICAqIEByZXR1cm4gcHJvbWlzZSByZXNvbHZlZCB3aXRoIG51bWJlciBvZiBtb3ZlZCBtZXNzYWdlc1xyXG4gICAgICovXHJcbiAgICBwdWJsaWMgYXN5bmMgbW92ZShqb2JDb25jdXJyZW5jeT0gNTApOiBQcm9taXNlPG51bWJlcj4ge1xyXG4gICAgICAgIGNvbnN0IG1vdmVKb2JzOiBQcm9taXNlPG51bWJlcj5bXSA9IFtdO1xyXG4gICAgICAgIGZvciAobGV0IGk9MDsgaSA8IGpvYkNvbmN1cnJlbmN5OyBpKyspIHtcclxuICAgICAgICAgICAgbW92ZUpvYnMucHVzaCh0aGlzLm1vdmVKb2IoKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFByb21pc2UuYWxsKG1vdmVKb2JzKTtcclxuICAgICAgICByZXR1cm4gcmVzdWx0LnJlZHVjZSggKHByZXZWYWx1ZSwgY3VycmVudFZhbHVlKSA9PiB7IHJldHVybiBwcmV2VmFsdWUgKyBjdXJyZW50VmFsdWV9LCAwKVxyXG4gICAgfVxyXG59XHJcbiJdfQ==