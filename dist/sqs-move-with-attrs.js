"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class SqsMoveWithAttrs {
    constructor(sqsClient, fromSqsUrl, toSqsUrl) {
        this.castMessageAttributes = (source) => {
            for (const key in source) {
                // noinspection JSUnfilteredForInLoop
                delete source[key].StringListValues;
                // noinspection JSUnfilteredForInLoop
                delete source[key].BinaryListValues;
            }
            return source;
        };
        this.sqsClient = sqsClient;
        this.fromSqsUrl = fromSqsUrl;
        this.toSqsUrl = toSqsUrl;
        this.receiveOptions = {
            MessageAttributeNames: [
                "All"
            ],
            QueueUrl: fromSqsUrl,
            MaxNumberOfMessages: 10,
            VisibilityTimeout: 30,
            WaitTimeSeconds: 0
        };
        this.processedMessagesCount = 0;
        this.receiveMessageRequestCount = 0;
    }
    reportProgress(numMessages) {
        this.processedMessagesCount += numMessages;
        process.stdout.write("\rMessages moved:" + this.processedMessagesCount);
    }
    /**
     * @return promise resolved with number of moved messages
     */
    async moveJob() {
        // eslint-disable-next-line no-async-promise-executor
        return new Promise(async (resolve, reject) => {
            const sendRequest = {
                QueueUrl: this.toSqsUrl,
                Entries: []
            };
            const deleteRequest = {
                QueueUrl: this.fromSqsUrl,
                Entries: []
            };
            let movedMessagesCount = 0;
            try {
                do {
                    // for Debugging
                    // if (++this.receiveMessageRequestCount > 100) {
                    //     resolve(movedMessagesCount);
                    //     return
                    // }
                    const response = await this.sqsClient.receiveMessage(this.receiveOptions).promise();
                    if (!response.Messages) {
                        resolve(movedMessagesCount);
                        return;
                    }
                    let id = 0;
                    sendRequest.Entries = [];
                    deleteRequest.Entries = [];
                    for (const message of response.Messages) {
                        if (message.Body && message.ReceiptHandle) {
                            id++;
                            const sendEntry = {
                                Id: '' + id,
                                MessageBody: message.Body
                            };
                            if (message.MessageAttributes) {
                                sendEntry.MessageAttributes = this.castMessageAttributes(message.MessageAttributes);
                            }
                            sendRequest.Entries.push(sendEntry);
                            deleteRequest.Entries.push({
                                Id: '' + id,
                                ReceiptHandle: message.ReceiptHandle
                            });
                        }
                    }
                    await this.sqsClient.sendMessageBatch(sendRequest).promise();
                    await this.sqsClient.deleteMessageBatch(deleteRequest).promise();
                    movedMessagesCount += response.Messages.length;
                    this.reportProgress(response.Messages.length);
                    // eslint-disable-next-line no-constant-condition
                } while (true);
            }
            catch (err) {
                reject(err);
            }
        });
    }
    /**
     * Do moving messages from source to destination queue
     * @param jobConcurrency
     * @return promise resolved with number of moved messages
     */
    async move(jobConcurrency = 50) {
        const moveJobs = [];
        for (let i = 0; i < jobConcurrency; i++) {
            moveJobs.push(this.moveJob());
        }
        const result = await Promise.all(moveJobs);
        return result.reduce((prevValue, currentValue) => { return prevValue + currentValue; }, 0);
    }
}
exports.SqsMoveWithAttrs = SqsMoveWithAttrs;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3FzLW1vdmUtd2l0aC1hdHRycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zcXMtbW92ZS13aXRoLWF0dHJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsTUFBYSxnQkFBZ0I7SUFVekIsWUFBWSxTQUFjLEVBQUUsVUFBa0IsRUFBRSxRQUFnQjtRQXdCeEQsMEJBQXFCLEdBQUcsQ0FBQyxNQUFtQyxFQUErQixFQUFFO1lBQ2pHLEtBQU0sTUFBTSxHQUFHLElBQUksTUFBTSxFQUFFO2dCQUN2QixxQ0FBcUM7Z0JBQ3JDLE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLGdCQUFnQixDQUFDO2dCQUNwQyxxQ0FBcUM7Z0JBQ3JDLE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLGdCQUFnQixDQUFDO2FBQ3ZDO1lBQ0QsT0FBTyxNQUFNLENBQUM7UUFDbEIsQ0FBQyxDQUFDO1FBL0JFLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBRXpCLElBQUksQ0FBQyxjQUFjLEdBQUc7WUFDbEIscUJBQXFCLEVBQUU7Z0JBQ25CLEtBQUs7YUFDUjtZQUNELFFBQVEsRUFBRSxVQUFVO1lBQ3BCLG1CQUFtQixFQUFFLEVBQUU7WUFDdkIsaUJBQWlCLEVBQUUsRUFBRTtZQUNyQixlQUFlLEVBQUUsQ0FBQztTQUNyQixDQUFDO1FBRUYsSUFBSSxDQUFDLHNCQUFzQixHQUFHLENBQUMsQ0FBQztRQUNoQyxJQUFJLENBQUMsMEJBQTBCLEdBQUcsQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFTyxjQUFjLENBQUMsV0FBbUI7UUFDdEMsSUFBSSxDQUFDLHNCQUFzQixJQUFJLFdBQVcsQ0FBQztRQUMzQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsR0FBQyxJQUFJLENBQUMs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LENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztTQUNqQztRQUNELE1BQU0sTUFBTSxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMzQyxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUUsQ0FBQyxTQUFTLEVBQUUsWUFBWSxFQUFFLEVBQUUsR0FBRyxPQUFPLFNBQVMsR0FBRyxZQUFZLENBQUEsQ0FBQSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDN0YsQ0FBQztDQUNKO0FBaklELDRDQWlJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7U1FTfSBmcm9tIFwiYXdzLXNka1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIFNxc01vdmVXaXRoQXR0cnMge1xyXG5cclxuICAgIHByaXZhdGUgcmVhZG9ubHkgc3FzQ2xpZW50OiBTUVM7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZyb21TcXNVcmw6IHN0cmluZztcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgdG9TcXNVcmw6IHN0cmluZztcclxuXHJcbiAgICBwcml2YXRlIHByb2Nlc3NlZE1lc3NhZ2VzQ291bnQ6IG51bWJlcjtcclxuICAgIHByaXZhdGUgcmVjZWl2ZU9wdGlvbnM6IFNRUy5SZWNlaXZlTWVzc2FnZVJlcXVlc3Q7XHJcbiAgICBwcml2YXRlIHJlY2VpdmVNZXNzYWdlUmVxdWVzdENvdW50OiBudW1iZXI7XHJcblxyXG4gICAgY29uc3RydWN0b3Ioc3FzQ2xpZW50OiBTUVMsIGZyb21TcXNVcmw6IHN0cmluZywgdG9TcXNVcmw6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuc3FzQ2xpZW50ID0gc3FzQ2xpZW50O1xyXG4gICAgICAgIHRoaXMuZnJvbVNxc1VybCA9IGZyb21TcXNVcmw7XHJcbiAgICAgICAgdGhpcy50b1Nxc1VybCA9IHRvU3FzVXJsO1xyXG5cclxuICAgICAgICB0aGlzLnJlY2VpdmVPcHRpb25zID0ge1xyXG4gICAgICAgICAgICBNZXNzYWdlQXR0cmlidXRlTmFtZXM6IFtcclxuICAgICAgICAgICAgICAgIFwiQWxsXCJcclxuICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgUXVldWVVcmw6IGZyb21TcXNVcmwsXHJcbiAgICAgICAgICAgIE1heE51bWJlck9mTWVzc2FnZXM6IDEwLFxyXG4gICAgICAgICAgICBWaXNpYmlsaXR5VGltZW91dDogMzAsXHJcbiAgICAgICAgICAgIFdhaXRUaW1lU2Vjb25kczogMFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRoaXMucHJvY2Vzc2VkTWVzc2FnZXNDb3VudCA9IDA7XHJcbiAgICAgICAgdGhpcy5yZWNlaXZlTWVzc2FnZVJlcXVlc3RDb3VudCA9IDA7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZXBvcnRQcm9ncmVzcyhudW1NZXNzYWdlczogbnVtYmVyKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5wcm9jZXNzZWRNZXNzYWdlc0NvdW50ICs9IG51bU1lc3NhZ2VzO1xyXG4gICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKFwiXFxyTWVzc2FnZXMgbW92ZWQ6XCIrdGhpcy5wcm9jZXNzZWRNZXNzYWdlc0NvdW50KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNhc3RNZXNzYWdlQXR0cmlidXRlcyA9IChzb3VyY2U6IFNRUy5NZXNzYWdlQm9keUF0dHJpYnV0ZU1hcCk6IFNRUy5NZXNzYWdlQm9keUF0dHJpYnV0ZU1hcCA9PiB7XHJcbiAgICAgICAgZm9yICggY29uc3Qga2V5IGluIHNvdXJjZSkge1xyXG4gICAgICAgICAgICAvLyBub2luc3BlY3Rpb24gSlNVbmZpbHRlcmVkRm9ySW5Mb29wXHJcbiAgICAgICAgICAgIGRlbGV0ZSBzb3VyY2Vba2V5XS5TdHJpbmdMaXN0VmFsdWVzO1xyXG4gICAgICAgICAgICAvLyBub2luc3BlY3Rpb24gSlNVbmZpbHRlcmVkRm9ySW5Mb29wXHJcbiAgICAgICAgICAgIGRlbGV0ZSBzb3VyY2Vba2V5XS5CaW5hcnlMaXN0VmFsdWVzO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc291cmNlO1xyXG4gICAgfTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEByZXR1cm4gcHJvbWlzZSByZXNvbHZlZCB3aXRoIG51bWJlciBvZiBtb3ZlZCBtZXNzYWdlc1xyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGFzeW5jIG1vdmVKb2IoKTogUHJvbWlzZTxudW1iZXI+IHtcclxuXHJcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWFzeW5jLXByb21pc2UtZXhlY3V0b3JcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoIGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHNlbmRSZXF1ZXN0OiBTUVMuU2VuZE1lc3NhZ2VCYXRjaFJlcXVlc3QgPSB7XHJcbiAgICAgICAgICAgICAgICBRdWV1ZVVybDogdGhpcy50b1Nxc1VybCxcclxuICAgICAgICAgICAgICAgIEVudHJpZXM6IFtdXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGNvbnN0IGRlbGV0ZVJlcXVlc3Q6IFNRUy5EZWxldGVNZXNzYWdlQmF0Y2hSZXF1ZXN0ID0ge1xyXG4gICAgICAgICAgICAgICAgUXVldWVVcmw6IHRoaXMuZnJvbVNxc1VybCxcclxuICAgICAgICAgICAgICAgIEVudHJpZXM6IFtdXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBsZXQgbW92ZWRNZXNzYWdlc0NvdW50ID0gMDtcclxuXHJcbiAgICAgICAgICAgIHRyeSB7XHJcblxyXG4gICAgICAgICAgICAgICAgZG8ge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGZvciBEZWJ1Z2dpbmdcclxuICAgICAgICAgICAgICAgICAgICAvLyBpZiAoKyt0aGlzLnJlY2VpdmVNZXNzYWdlUmVxdWVzdENvdW50ID4gMTAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgIHJlc29sdmUobW92ZWRNZXNzYWdlc0NvdW50KTtcclxuICAgICAgICAgICAgICAgICAgICAvLyAgICAgcmV0dXJuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZTogU1FTLlJlY2VpdmVNZXNzYWdlUmVzdWx0ID0gYXdhaXQgdGhpcy5zcXNDbGllbnQucmVjZWl2ZU1lc3NhZ2UodGhpcy5yZWNlaXZlT3B0aW9ucykucHJvbWlzZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghcmVzcG9uc2UuTWVzc2FnZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShtb3ZlZE1lc3NhZ2VzQ291bnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBpZCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VuZFJlcXVlc3QuRW50cmllcyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlcXVlc3QuRW50cmllcyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgbWVzc2FnZSBvZiByZXNwb25zZS5NZXNzYWdlcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobWVzc2FnZS5Cb2R5ICYmIG1lc3NhZ2UuUmVjZWlwdEhhbmRsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQrKztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlbmRFbnRyeTogU1FTLlNlbmRNZXNzYWdlQmF0Y2hSZXF1ZXN0RW50cnkgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSWQ6ICcnK2lkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1lc3NhZ2VCb2R5OiBtZXNzYWdlLkJvZHlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWVzc2FnZS5NZXNzYWdlQXR0cmlidXRlcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRFbnRyeS5NZXNzYWdlQXR0cmlidXRlcyA9IHRoaXMuY2FzdE1lc3NhZ2VBdHRyaWJ1dGVzKG1lc3NhZ2UuTWVzc2FnZUF0dHJpYnV0ZXMpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZW5kUmVxdWVzdC5FbnRyaWVzLnB1c2goc2VuZEVudHJ5KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlcXVlc3QuRW50cmllcy5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJZDogJycraWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUmVjZWlwdEhhbmRsZTogbWVzc2FnZS5SZWNlaXB0SGFuZGxlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnNxc0NsaWVudC5zZW5kTWVzc2FnZUJhdGNoKHNlbmRSZXF1ZXN0KS5wcm9taXNlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5zcXNDbGllbnQuZGVsZXRlTWVzc2FnZUJhdGNoKGRlbGV0ZVJlcXVlc3QpLnByb21pc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICBtb3ZlZE1lc3NhZ2VzQ291bnQgKz0gcmVzcG9uc2UuTWVzc2FnZXMubGVuZ3RoO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlcG9ydFByb2dyZXNzKHJlc3BvbnNlLk1lc3NhZ2VzLmxlbmd0aCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zdGFudC1jb25kaXRpb25cclxuICAgICAgICAgICAgICAgIH0gd2hpbGUgKHRydWUpO1xyXG5cclxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIERvIG1vdmluZyBtZXNzYWdlcyBmcm9tIHNvdXJjZSB0byBkZXN0aW5hdGlvbiBxdWV1ZVxyXG4gICAgICogQHBhcmFtIGpvYkNvbmN1cnJlbmN5XHJcbiAgICAgKiBAcmV0dXJuIHByb21pc2UgcmVzb2x2ZWQgd2l0aCBudW1iZXIgb2YgbW92ZWQgbWVzc2FnZXNcclxuICAgICAqL1xyXG4gICAgcHVibGljIGFzeW5jIG1vdmUoam9iQ29uY3VycmVuY3k9IDUwKTogUHJvbWlzZTxudW1iZXI+IHtcclxuICAgICAgICBjb25zdCBtb3ZlSm9iczogUHJvbWlzZTxudW1iZXI+W10gPSBbXTtcclxuICAgICAgICBmb3IgKGxldCBpPTA7IGkgPCBqb2JDb25jdXJyZW5jeTsgaSsrKSB7XHJcbiAgICAgICAgICAgIG1vdmVKb2JzLnB1c2godGhpcy5tb3ZlSm9iKCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBQcm9taXNlLmFsbChtb3ZlSm9icyk7XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdC5yZWR1Y2UoIChwcmV2VmFsdWUsIGN1cnJlbnRWYWx1ZSkgPT4geyByZXR1cm4gcHJldlZhbHVlICsgY3VycmVudFZhbHVlfSwgMClcclxuICAgIH1cclxufVxyXG4iXX0=