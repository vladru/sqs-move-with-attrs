#!/usr/bin/env node
'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
process.env.AWS_SDK_LOAD_CONFIG = "true";
const aws_sdk_1 = require("aws-sdk");
const sqs_move_with_attrs_1 = require("./sqs-move-with-attrs");
const utils_1 = require("./utils");
console.log("Move all messages with its attributes from one AWS SQS queue to another.");
const resolveSqsUrl = async (sqsUrlOrName) => {
    if (utils_1.isSqsUrlFormatValid(sqsUrlOrName)) {
        return { sqsUrl: sqsUrlOrName };
    }
    if (!utils_1.isSqsNameFormatValid(sqsUrlOrName)) {
        return {
            sqsUrl: null,
            errorMessage: "Invalid format for SQS URL of SQS name: '" + sqsUrlOrName + "'"
        };
    }
    const awsRegion = utils_1.getCurrentAwsRegion();
    if (!awsRegion) {
        return {
            sqsUrl: null,
            errorMessage: "Can't determine AWS Region to build SQS URL from SQS name '" + sqsUrlOrName + "'"
        };
    }
    const awsAccountId = await utils_1.getAwsAccountId();
    if (!awsAccountId) {
        return {
            sqsUrl: null,
            errorMessage: "Can't determine AWS Account ID to build SQS URL from SQS name '" + sqsUrlOrName + "'"
        };
    }
    return { sqsUrl: `https://sqs.${awsRegion}.amazonaws.com/${awsAccountId}/${sqsUrlOrName}` };
};
(async () => {
    try {
        let fromSqsUrl;
        let toSqsUrl;
        let errorMessage;
        if (process.argv.length != 4) {
            errorMessage = "Unexpected number of arguments.";
        }
        else {
            let resolveSqsUrlResult = await resolveSqsUrl(process.argv[2]);
            if (!resolveSqsUrlResult.sqsUrl) {
                errorMessage = resolveSqsUrlResult.errorMessage;
            }
            else {
                fromSqsUrl = resolveSqsUrlResult.sqsUrl;
                resolveSqsUrlResult = await resolveSqsUrl(process.argv[3]);
                if (!resolveSqsUrlResult.sqsUrl) {
                    errorMessage = resolveSqsUrlResult.errorMessage;
                }
                else {
                    toSqsUrl = resolveSqsUrlResult.sqsUrl;
                }
            }
        }
        if (!utils_1.getCurrentAwsRegion()) {
            console.error("Missing region in config.");
            console.log("Define AWS_REGION environment variable or specify region in AWS config file.");
            process.exitCode = -1;
            return;
        }
        if (errorMessage || !fromSqsUrl || !toSqsUrl) {
            console.log("ERROR: %s", errorMessage);
            console.log("Use:\n\tyarn move <source_SQS_URL_or_name> <destination_SQS_url_or_name>");
            console.log("Expected SQS URL format: 'https://sqs.<region>.amazonaws.com/<account_id>/<queue_name>'");
            process.exitCode = -1;
            return;
        }
        console.log("     source: %s", fromSqsUrl);
        console.log("destination: %s", toSqsUrl);
        const sqsClient = new aws_sdk_1.SQS();
        const sqsMove = new sqs_move_with_attrs_1.SqsMoveWithAttrs(sqsClient, fromSqsUrl, toSqsUrl);
        const startTime = new Date().getTime();
        const movedMessagesCount = await sqsMove.move();
        const endTime = new Date().getTime();
        console.log("\r%d messages have been moved within %d sec.", movedMessagesCount, Math.round((endTime - startTime) / 1000));
    }
    catch (e) {
        console.error(e);
        process.exitCode = -1;
    }
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NsaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsWUFBWSxDQUFDOztBQUViLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLEdBQUcsTUFBTSxDQUFDO0FBQ3pDLHFDQUE0QjtBQUU1QiwrREFBdUQ7QUFDdkQsbUNBQXdHO0FBRXhHLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEVBQTBFLENBQUMsQ0FBQztBQU94RixNQUFNLGFBQWEsR0FBRyxLQUFLLEVBQUUsWUFBb0IsRUFBZ0MsRUFBRTtJQUMvRSxJQUFJLDJCQUFtQixDQUFDLFlBQVksQ0FBQyxFQUFFO1FBQ25DLE9BQU8sRUFBQyxNQUFNLEVBQUUsWUFBWSxFQUFDLENBQUE7S0FDaEM7SUFDRCxJQUFJLENBQUMsNEJBQW9CLENBQUMsWUFBWSxDQUFDLEVBQUU7UUFDckMsT0FBTztZQUNILE1BQU0sRUFBRSxJQUFJO1lBQ1osWUFBWSxFQUFFLDJDQUEyQyxHQUFDLFlBQVksR0FBQyxHQUFHO1NBQzdFLENBQUE7S0FDSjtJQUNELE1BQU0sU0FBUyxHQUFHLDJCQUFtQixFQUFFLENBQUM7SUFDeEMsSUFBSSxDQUFDLFNBQVMsRUFBRTtRQUNaLE9BQU87WUFDSCxNQUFNLEVBQUUsSUFBSTtZQUNaLFlBQVksRUFBRSw2REFBNkQsR0FBQyxZQUFZLEdBQUMsR0FBRztTQUMvRixDQUFBO0tBQ0o7SUFDRCxNQUFNLFlBQVksR0FBRyxNQUFNLHVCQUFlLEVBQUUsQ0FBQztJQUM3QyxJQUFJLENBQUMsWUFBWSxFQUFFO1FBQ2YsT0FBTztZQUNILE1BQU0sRUFBRSxJQUFJO1lBQ1osWUFBWSxFQUFFLGlFQUFpRSxHQUFDLFlBQVksR0FBQyxHQUFHO1NBQ25HLENBQUE7S0FDSjtJQUNELE9BQU8sRUFBQyxNQUFNLEVBQUUsZUFBZSxTQUFTLGtCQUFrQixZQUFZLElBQUksWUFBWSxFQUFFLEVBQUMsQ0FBQTtBQUM3RixDQUFDLENBQUM7QUFFRixDQUFDLEtBQUssSUFBbUIsRUFBRTtJQUN2QixJQUFJO1FBQ0EsSUFBSSxVQUE4QixDQUFDO1FBQ25DLElBQUksUUFBNEIsQ0FBQztRQUNqQyxJQUFJLFlBQWdDLENBQUM7UUFDckMsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUU7WUFDMUIsWUFBWSxHQUFHLGlDQUFpQyxDQUFDO1NBQ3BEO2FBQU07WUFDSCxJQUFJLG1CQUFtQixHQUFHLE1BQU0sYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvRCxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxFQUFFO2dCQUM3QixZQUFZLEdBQUcsbUJBQW1CLENBQUMsWUFBWSxDQUFDO2FBQ25EO2lCQUFNO2dCQUNILFVBQVUsR0FBRyxtQkFBbUIsQ0FBQyxNQUFNLENBQUM7Z0JBQ3hDLG1CQUFtQixHQUFHLE1BQU0sYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDM0QsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sRUFBRTtvQkFDN0IsWUFBWSxHQUFHLG1CQUFtQixDQUFDLFlBQVksQ0FBQTtpQkFDbEQ7cUJBQU07b0JBQ0gsUUFBUSxHQUFHLG1CQUFtQixDQUFDLE1BQU0sQ0FBQTtpQkFDeEM7YUFDSjtTQUNKO1FBRUQsSUFBSSxDQUFDLDJCQUFtQixFQUFFLEVBQUU7WUFDeEIsT0FBTyxDQUFDLEtBQUssQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1lBQzNDLE9BQU8sQ0FBQyxHQUFHLENBQUMsOEVBQThFLENBQUMsQ0FBQztZQUM1RixPQUFPLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3RCLE9BQU07U0FDVDtRQUVELElBQUksWUFBWSxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ3RDLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEVBQTBFLENBQUMsQ0FBQztZQUN4RixPQUFPLENBQUMsR0FBRyxDQUFDLHlGQUF5RixDQUFDLENBQUM7WUFDdkcsT0FBTyxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUN0QixPQUFNO1NBQ1Q7UUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQzNDLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFekMsTUFBTSxTQUFTLEdBQUcsSUFBSSxhQUFHLEVBQUUsQ0FBQztRQUM1QixNQUFNLE9BQU8sR0FBRyxJQUFJLHNDQUFnQixDQUFDLFNBQVMsRUFBRSxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDdEUsTUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUN2QyxNQUFNLGtCQUFrQixHQUFHLE1BQU0sT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2hELE1BQU0sT0FBTyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDckMsT0FBTyxDQUFDLEdBQUcsQ0FBQyw4Q0FBOEMsRUFBRSxrQkFBa0IsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxHQUFDLFNBQVMsQ0FBQyxHQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7S0FFeEg7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNSLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakIsT0FBTyxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsQ0FBQztLQUN6QjtBQUNMLENBQUMsQ0FBQyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIjIS91c3IvYmluL2VudiBub2RlXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbnByb2Nlc3MuZW52LkFXU19TREtfTE9BRF9DT05GSUcgPSBcInRydWVcIjtcclxuaW1wb3J0IHtTUVN9IGZyb20gXCJhd3Mtc2RrXCI7XHJcblxyXG5pbXBvcnQge1Nxc01vdmVXaXRoQXR0cnN9IGZyb20gXCIuL3Nxcy1tb3ZlLXdpdGgtYXR0cnNcIjtcclxuaW1wb3J0IHtnZXRBd3NBY2NvdW50SWQsIGdldEN1cnJlbnRBd3NSZWdpb24sIGlzU3FzTmFtZUZvcm1hdFZhbGlkLCBpc1Nxc1VybEZvcm1hdFZhbGlkfSBmcm9tIFwiLi91dGlsc1wiO1xyXG5cclxuY29uc29sZS5sb2coXCJNb3ZlIGFsbCBtZXNzYWdlcyB3aXRoIGl0cyBhdHRyaWJ1dGVzIGZyb20gb25lIEFXUyBTUVMgcXVldWUgdG8gYW5vdGhlci5cIik7XHJcblxyXG5pbnRlcmZhY2UgUmVzb2x2ZVNxc1VybFJlc3VsdCB7XHJcbiAgICBzcXNVcmw6IHN0cmluZyB8IG51bGw7XHJcbiAgICBlcnJvck1lc3NhZ2U/OiBzdHJpbmc7XHJcbn1cclxuXHJcbmNvbnN0IHJlc29sdmVTcXNVcmwgPSBhc3luYyAoc3FzVXJsT3JOYW1lOiBzdHJpbmcpOiBQcm9taXNlPFJlc29sdmVTcXNVcmxSZXN1bHQ+ID0+IHtcclxuICAgIGlmIChpc1Nxc1VybEZvcm1hdFZhbGlkKHNxc1VybE9yTmFtZSkpIHtcclxuICAgICAgICByZXR1cm4ge3Nxc1VybDogc3FzVXJsT3JOYW1lfVxyXG4gICAgfVxyXG4gICAgaWYgKCFpc1Nxc05hbWVGb3JtYXRWYWxpZChzcXNVcmxPck5hbWUpKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgc3FzVXJsOiBudWxsLFxyXG4gICAgICAgICAgICBlcnJvck1lc3NhZ2U6IFwiSW52YWxpZCBmb3JtYXQgZm9yIFNRUyBVUkwgb2YgU1FTIG5hbWU6ICdcIitzcXNVcmxPck5hbWUrXCInXCJcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBjb25zdCBhd3NSZWdpb24gPSBnZXRDdXJyZW50QXdzUmVnaW9uKCk7XHJcbiAgICBpZiAoIWF3c1JlZ2lvbikge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHNxc1VybDogbnVsbCxcclxuICAgICAgICAgICAgZXJyb3JNZXNzYWdlOiBcIkNhbid0IGRldGVybWluZSBBV1MgUmVnaW9uIHRvIGJ1aWxkIFNRUyBVUkwgZnJvbSBTUVMgbmFtZSAnXCIrc3FzVXJsT3JOYW1lK1wiJ1wiXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgY29uc3QgYXdzQWNjb3VudElkID0gYXdhaXQgZ2V0QXdzQWNjb3VudElkKCk7XHJcbiAgICBpZiAoIWF3c0FjY291bnRJZCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHNxc1VybDogbnVsbCxcclxuICAgICAgICAgICAgZXJyb3JNZXNzYWdlOiBcIkNhbid0IGRldGVybWluZSBBV1MgQWNjb3VudCBJRCB0byBidWlsZCBTUVMgVVJMIGZyb20gU1FTIG5hbWUgJ1wiK3Nxc1VybE9yTmFtZStcIidcIlxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB7c3FzVXJsOiBgaHR0cHM6Ly9zcXMuJHthd3NSZWdpb259LmFtYXpvbmF3cy5jb20vJHthd3NBY2NvdW50SWR9LyR7c3FzVXJsT3JOYW1lfWB9XHJcbn07XHJcblxyXG4oYXN5bmMgKCk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBsZXQgZnJvbVNxc1VybDogc3RyaW5nIHwgdW5kZWZpbmVkO1xyXG4gICAgICAgIGxldCB0b1Nxc1VybDogc3RyaW5nIHwgdW5kZWZpbmVkO1xyXG4gICAgICAgIGxldCBlcnJvck1lc3NhZ2U6IHN0cmluZyB8IHVuZGVmaW5lZDtcclxuICAgICAgICBpZiAocHJvY2Vzcy5hcmd2Lmxlbmd0aCAhPSA0KSB7XHJcbiAgICAgICAgICAgIGVycm9yTWVzc2FnZSA9IFwiVW5leHBlY3RlZCBudW1iZXIgb2YgYXJndW1lbnRzLlwiO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxldCByZXNvbHZlU3FzVXJsUmVzdWx0ID0gYXdhaXQgcmVzb2x2ZVNxc1VybChwcm9jZXNzLmFyZ3ZbMl0pO1xyXG4gICAgICAgICAgICBpZiAoIXJlc29sdmVTcXNVcmxSZXN1bHQuc3FzVXJsKSB7XHJcbiAgICAgICAgICAgICAgICBlcnJvck1lc3NhZ2UgPSByZXNvbHZlU3FzVXJsUmVzdWx0LmVycm9yTWVzc2FnZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGZyb21TcXNVcmwgPSByZXNvbHZlU3FzVXJsUmVzdWx0LnNxc1VybDtcclxuICAgICAgICAgICAgICAgIHJlc29sdmVTcXNVcmxSZXN1bHQgPSBhd2FpdCByZXNvbHZlU3FzVXJsKHByb2Nlc3MuYXJndlszXSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXJlc29sdmVTcXNVcmxSZXN1bHQuc3FzVXJsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlID0gcmVzb2x2ZVNxc1VybFJlc3VsdC5lcnJvck1lc3NhZ2VcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdG9TcXNVcmwgPSByZXNvbHZlU3FzVXJsUmVzdWx0LnNxc1VybFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIWdldEN1cnJlbnRBd3NSZWdpb24oKSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiTWlzc2luZyByZWdpb24gaW4gY29uZmlnLlwiKTtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJEZWZpbmUgQVdTX1JFR0lPTiBlbnZpcm9ubWVudCB2YXJpYWJsZSBvciBzcGVjaWZ5IHJlZ2lvbiBpbiBBV1MgY29uZmlnIGZpbGUuXCIpO1xyXG4gICAgICAgICAgICBwcm9jZXNzLmV4aXRDb2RlID0gLTE7XHJcbiAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGVycm9yTWVzc2FnZSB8fCAhZnJvbVNxc1VybCB8fCAhdG9TcXNVcmwpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJFUlJPUjogJXNcIixlcnJvck1lc3NhZ2UpO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlVzZTpcXG5cXHR5YXJuIG1vdmUgPHNvdXJjZV9TUVNfVVJMX29yX25hbWU+IDxkZXN0aW5hdGlvbl9TUVNfdXJsX29yX25hbWU+XCIpO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkV4cGVjdGVkIFNRUyBVUkwgZm9ybWF0OiAnaHR0cHM6Ly9zcXMuPHJlZ2lvbj4uYW1hem9uYXdzLmNvbS88YWNjb3VudF9pZD4vPHF1ZXVlX25hbWU+J1wiKTtcclxuICAgICAgICAgICAgcHJvY2Vzcy5leGl0Q29kZSA9IC0xO1xyXG4gICAgICAgICAgICByZXR1cm5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnNvbGUubG9nKFwiICAgICBzb3VyY2U6ICVzXCIsIGZyb21TcXNVcmwpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFwiZGVzdGluYXRpb246ICVzXCIsIHRvU3FzVXJsKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc3FzQ2xpZW50ID0gbmV3IFNRUygpO1xyXG4gICAgICAgIGNvbnN0IHNxc01vdmUgPSBuZXcgU3FzTW92ZVdpdGhBdHRycyhzcXNDbGllbnQsIGZyb21TcXNVcmwsIHRvU3FzVXJsKTtcclxuICAgICAgICBjb25zdCBzdGFydFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcclxuICAgICAgICBjb25zdCBtb3ZlZE1lc3NhZ2VzQ291bnQgPSBhd2FpdCBzcXNNb3ZlLm1vdmUoKTtcclxuICAgICAgICBjb25zdCBlbmRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJcXHIlZCBtZXNzYWdlcyBoYXZlIGJlZW4gbW92ZWQgd2l0aGluICVkIHNlYy5cIiwgbW92ZWRNZXNzYWdlc0NvdW50LCBNYXRoLnJvdW5kKChlbmRUaW1lLXN0YXJ0VGltZSkvMTAwMCkpXHJcblxyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XHJcbiAgICAgICAgcHJvY2Vzcy5leGl0Q29kZSA9IC0xO1xyXG4gICAgfVxyXG59KSgpO1xyXG4iXX0=